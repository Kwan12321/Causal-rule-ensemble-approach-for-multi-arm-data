df1.names
pic.can <- list()
count <- 0
for(rn in 1: length(df1.names)){
count <- count + 1
g11 <- ggplot(data = df1, aes_string(fill = df1.names[rn]))  + ggtitle(colnames(weight.r)[rn])
g11 <- g11 + geom_sf(color = "transparent",  size = 0.1) + ylim(c(-80,130))
g11 <- g11 + scale_fill_viridis_c("Contribuion to the Risk \n of covid-19 infection", option = "turbo")
g11 <- g11 + theme_bw() + theme(legend.position = "bottom", plot.title = element_text(size=22), text = element_text(size = 15))
pic.can[[count]] <- g11
count <- count + 1
g22 <- ggplot(data = df2, aes_string(fill = df2.names[rn]))  + ggtitle(df2.names[rn])
g22 <- g22 + geom_sf(color = "transparent",  size = 0.1)
g22 <- g22 + scale_fill_viridis_c("Contribuion to the Risk \n of covid-19 infection", option = "turbo")
g22 <- g22 + theme_bw() + theme(legend.position = "bottom", plot.title = element_text(size=22), text = element_text(size = 15))
pic.can[[count]] <- g22
}
library(ggpubr)
gg1 <-  ggarrange(pic.can[[1]] + labs(title =  rules.select[1])+ guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[3]] + labs(title =  rules.select[2]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[5]]  + labs(title =  rules.select[3]) +  guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[7]] + labs(title =  rules.select[4]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[9]]  + labs(title =  rules.select[5]) +  guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[11]]  + labs(title =  rules.select[5]) +  guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
ncol = 3, nrow = 2, common.legend = TRUE, legend="bottom")
gg1
count <- count + 1
g11 <- ggplot(data = df1, aes_string(fill = df1.names[rn]))  + ggtitle(colnames(weight.r)[rn])
g11 <- g11 + geom_sf(color = "transparent",  size = 0.1) + ylim(c(-80,130))
g11 <- g11 + scale_fill_viridis_c("Contribuion to the Risk \n of covid-19 infection", option = "turbo")
g11 <- g11 + theme_bw() + theme(legend.position = "bottom", plot.title = element_text(size=22), text = element_text(size = 15))
pic.can[[count]] <- g11
df1
gg1
### Proposed method ###
set.seed(333)
formula <- as.formula("covid19_r ~ ethnic + lt_illness + imd19_ext + hlthsoc_sec + educ_sec + trnsp_sec + accfood_sec + admsupport_sec + pblic_sec")
bw <- gwim_cv(formula, data = data.frame(df), coords = cbind(df$long, df$lat), gweight = gwr.Gauss, adapt = FALSE)
res <- gwim(formula, data = data.frame(df), coords = cbind(df$long, df$lat), bw = bw$bw, steps = bw$kmax)
rnames <- paste0("r", 1:length(res$rules))
weight.r <- data.frame(res$res[,rnames])
colnames(weight.r) <- res$rules
var.select <- c()
rules.select <- c()
for(r in 1:length(res$rules)){
rules.can <- strsplit(res$rules[r], "<")[[1]]
if(length(rules.can)==2){
var.select[r] <- rules.can[1]
rules.select[r] <- paste0(rules.can[1], "<", round(as.numeric(rules.can[2]),2))
}else{
rules.can <- strsplit(res$rules[r], ">")[[1]]
var.select[r] <- rules.can[1]
rules.select[r] <- paste0(rules.can[1], ">", round(as.numeric(rules.can[2]),2))
}
}
colnames(weight.r) <- rules.select
df1 <- cbind(df, weight.r)
df1.names <- colnames(data.frame(weight.r))
### GWR ###
bw4 <-  gwr.sel(formula, data = df, coords=cbind(df$long, df$lat), longlat = TRUE, adapt=FALSE, gweight = gwr.Gauss, verbose = FALSE)
res4 <- gwr(formula, data = data.frame(df), coords=cbind(df$long, df$lat), longlat = TRUE, bandwidth = bw4, gweight = gwr.Gauss)$SDF
weight.gwr <- res4[,var.select]
df2 <- cbind(df[,!is.element(colnames(df), names(weight.gwr))], weight.gwr)
df2.names <- colnames(data.frame(weight.gwr))
##################################################################################################
pic.can <- list()
count <- 0
for(rn in 1: length(df1.names)){
count <- count + 1
g11 <- ggplot(data = df1, aes_string(fill = df1.names[rn]))  + ggtitle(colnames(weight.r)[rn])
g11 <- g11 + geom_sf(color = "transparent",  size = 0.1) + ylim(c(-80,130))
g11 <- g11 + scale_fill_viridis_c("Contribuion to the Risk \n of covid-19 infection", option = "turbo")
g11 <- g11 + theme_bw() + theme(legend.position = "bottom", plot.title = element_text(size=22), text = element_text(size = 15))
pic.can[[count]] <- g11
count <- count + 1
g22 <- ggplot(data = df2, aes_string(fill = df2.names[rn]))  + ggtitle(df2.names[rn])
g22 <- g22 + geom_sf(color = "transparent",  size = 0.1)
g22 <- g22 + scale_fill_viridis_c("Contribuion to the Risk \n of covid-19 infection", option = "turbo")
g22 <- g22 + theme_bw() + theme(legend.position = "bottom", plot.title = element_text(size=22), text = element_text(size = 15))
pic.can[[count]] <- g22
}
pic.can <- list()
count <- 0
rn <- 1
count <- count + 1
g11 <- ggplot(data = df1, aes_string(fill = df1.names[rn]))  + ggtitle(colnames(weight.r)[rn])
g11 <- g11 + geom_sf(color = "transparent",  size = 0.1) + ylim(c(-80,130))
g11 <- g11 + scale_fill_viridis_c("Contribuion to the Risk \n of covid-19 infection", option = "turbo")
g11 <- g11 + theme_bw() + theme(legend.position = "bottom", plot.title = element_text(size=22), text = element_text(size = 15))
g11
df1
g11 <- ggplot(data = df1, aes_string(fill = df1.names[rn]))  + ggtitle(colnames(weight.r)[rn])
g11
g11 <- g11 + geom_sf(color = "transparent",  size = 0.1)
g11
pic.can <- list()
count <- 0
for(rn in 1: length(df1.names)){
count <- count + 1
g11 <- ggplot(data = df1, aes_string(fill = df1.names[rn]))  + ggtitle(colnames(weight.r)[rn])
g11 <- g11 + geom_sf(color = "transparent",  size = 0.1)
g11 <- g11 + scale_fill_viridis_c("Contribuion to the Risk \n of covid-19 infection", option = "turbo")
g11 <- g11 + theme_bw() + theme(legend.position = "bottom", plot.title = element_text(size=22), text = element_text(size = 15))
pic.can[[count]] <- g11
count <- count + 1
g22 <- ggplot(data = df2, aes_string(fill = df2.names[rn]))  + ggtitle(df2.names[rn])
g22 <- g22 + geom_sf(color = "transparent",  size = 0.1)
g22 <- g22 + scale_fill_viridis_c("Contribuion to the Risk \n of covid-19 infection", option = "turbo")
g22 <- g22 + theme_bw() + theme(legend.position = "bottom", plot.title = element_text(size=22), text = element_text(size = 15))
pic.can[[count]] <- g22
}
library(ggpubr)
gg1 <-  ggarrange(pic.can[[1]] + labs(title =  rules.select[1])+ guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[3]] + labs(title =  rules.select[2]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[5]]  + labs(title =  rules.select[3]) +  guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[7]] + labs(title =  rules.select[4]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[9]]  + labs(title =  rules.select[5]) +  guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[11]]  + labs(title =  rules.select[5]) +  guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
ncol = 3, nrow = 2, common.legend = TRUE, legend="bottom")
ggsave(paste0(dir,"real_gwim.png"), gg1, width = 18, height = 16)
gg2 <-  ggarrange(pic.can[[2]] + labs(title =  var.select[1]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[4]] + labs(title =  var.select[2]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[6]] + labs(title =  var.select[3]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[8]] + labs(title =  var.select[4]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[10]] + labs(title =  var.select[5]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[12]] + labs(title =  var.select[5]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
ncol = 3, nrow = 2, common.legend = TRUE, legend="bottom")
ggsave(paste0(dir,"real_gwr.png"), gg2, width = 18, height = 16)
res
set.seed(333)
formula <- as.formula("covid19_r ~ ethnic + lt_illness + imd19_ext + hlthsoc_sec + educ_sec + trnsp_sec + accfood_sec + admsupport_sec + pblic_sec")
bw <- gwim_cv(formula, data = data.frame(df), coords = cbind(df$long, df$lat), gweight = gwr.Gauss, adapt = FALSE)
res <- gwim(formula, data = data.frame(df), coords = cbind(df$long, df$lat), bw = bw$bw, steps = bw$kmax)
rnames <- paste0("r", 1:length(res$rules))
weight.r <- data.frame(res$res[,rnames])
colnames(weight.r) <- res$rules
var.select <- c()
rules.select <- c()
for(r in 1:length(res$rules)){
rules.can <- strsplit(res$rules[r], "<")[[1]]
if(length(rules.can)==2){
var.select[r] <- rules.can[1]
rules.select[r] <- paste0(rules.can[1], "<", round(as.numeric(rules.can[2]),2))
}else{
rules.can <- strsplit(res$rules[r], ">")[[1]]
var.select[r] <- rules.can[1]
rules.select[r] <- paste0(rules.can[1], ">", round(as.numeric(rules.can[2]),2))
}
}
colnames(weight.r) <- rules.select
rules.select
var.select
library(ggpubr)
gg1 <-  ggarrange(pic.can[[1]] + labs(title =  rules.select[1])+ guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[3]] + labs(title =  rules.select[2]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[5]]  + labs(title =  rules.select[3]) +  guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[7]] + labs(title =  rules.select[4]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[9]]  + labs(title =  rules.select[5]) +  guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[11]]  + labs(title =  rules.select[5]) +  guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
ncol = 3, nrow = 2, common.legend = TRUE, legend="bottom")
ggsave(paste0(dir,"real_gwim.png"), gg1, width = 18, height = 16)
gg2 <-  ggarrange(pic.can[[2]] + labs(title =  var.select[1]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[4]] + labs(title =  var.select[2]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[6]] + labs(title =  var.select[3]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[8]] + labs(title =  var.select[4]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[10]] + labs(title =  var.select[5]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[12]] + labs(title =  var.select[5]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
ncol = 3, nrow = 2, common.legend = TRUE, legend="bottom")
gg1
df2.names
length(df1.names)
library(tidyverse)
library(spgwr)
library(sp)
# Direction
dir <- "C:/Users/Owner/OneDrive/デスクトップ/GWR/"
dir <- "C:/Users/Owner/OneDrive/デスクトップ/GWR-CODE/"
# Source code ------------------------------------------------------------------
source(paste0(dir,"GWR_gwim.R"))
source(paste0(dir,"GWR_gwim_cv.R"))
source(paste0(dir,"GWR_gwim2.R"))
source(paste0(dir,"GWR_gwim2_cv.R"))
source(paste0(dir,"GWR_gwim3.R"))
source(paste0(dir,"GWR_gwim3_cv.R"))
# Read data
reg_shp <- sf::st_read(paste0(dir,"/Regions_December_2019_Boundaries_EN_BGC.shp"))
df <- sf::st_read(paste0(dir, "Covid19_total_cases_geo.shp")) %>%
select(objct, cty19c, ctyu19nm, long, lat, st_rs, st_ln, X2020.04.14,
I.PL1, IMD20, IMD2., Rsdnt, Hshld, Dwlln, Hsh_S, E_16_, A_65_, Ag_85,
Mixed, Indin, Pkstn, Bngld, Chins, Oth_A, Black, Othr_t, CB_U_, Crwd_,
Lng__, Trn__, Adm__, Ac___, Pb___, Edctn, H____, geometry)
# replace nas with 0s
df[is.na(df)] <- 0
# risk of covid-19 infection -----------------> OUTCOME
df$covid19_r <- (df$X2020.04.14 / df$Rsdnt) * 100000
# histogram
ggplot(data = df) +
geom_density(alpha=0.8, colour="black", fill="lightblue", aes(x = covid19_r)) +
theme_classic()
# Define Covariates -------------------------
df <- df %>% mutate(
crowded_hou = Crwd_ / Hshld, # share of crowded housing
elderly = (A_65_ + Ag_85) / Rsdnt, # share of population aged 65+
lt_illness = Lng__ / Rsdnt, # share of population in long-term illness
ethnic = (Mixed + Indin + Pkstn + Bngld + Chins + Oth_A + Black + Othr_t) / Rsdnt, # share of nonwhite population
imd19_ext = IMD20, # proportion of a larger area’s population living in the most deprived LSOAs in the country
hlthsoc_sec = H____ / E_16_, # share of workforce in the human health & social work sector
educ_sec = Edctn / E_16_, # share of workforce in the education sector
trnsp_sec= Trn__ / E_16_, # share of workforce in the Transport & storage sector
accfood_sec = Ac___ / E_16_, # share of workforce in the accommodation & food service sector
admsupport_sec = Adm__ /  E_16_, # share of workforce in the administrative & support sector
pblic_sec = Pb___ / E_16_ # share of workforce in the public administration & defence sector
)
n <- nrow(df)
# -------------------------------------------
### Proposed method ###
set.seed(333)
formula <- as.formula("covid19_r ~ ethnic + lt_illness + imd19_ext + hlthsoc_sec + educ_sec + trnsp_sec + accfood_sec + admsupport_sec + pblic_sec")
bw <- gwim_cv(formula, data = data.frame(df), coords = cbind(df$long, df$lat), gweight = gwr.Gauss, adapt = FALSE)
res <- gwim(formula, data = data.frame(df), coords = cbind(df$long, df$lat), bw = bw$bw, steps = bw$kmax)
rnames <- paste0("r", 1:length(res$rules))
weight.r <- data.frame(res$res[,rnames])
colnames(weight.r) <- res$rules
var.select <- c()
rules.select <- c()
for(r in 1:length(res$rules)){
rules.can <- strsplit(res$rules[r], "<")[[1]]
if(length(rules.can)==2){
var.select[r] <- rules.can[1]
rules.select[r] <- paste0(rules.can[1], "<", round(as.numeric(rules.can[2]),2))
}else{
rules.can <- strsplit(res$rules[r], ">")[[1]]
var.select[r] <- rules.can[1]
rules.select[r] <- paste0(rules.can[1], ">", round(as.numeric(rules.can[2]),2))
}
}
colnames(weight.r) <- rules.select
df1 <- cbind(df, weight.r)
df1.names <- colnames(data.frame(weight.r))
### GWR ###
bw4 <-  gwr.sel(formula, data = df, coords=cbind(df$long, df$lat), longlat = TRUE, adapt=FALSE, gweight = gwr.Gauss, verbose = FALSE)
res4 <- gwr(formula, data = data.frame(df), coords=cbind(df$long, df$lat), longlat = TRUE, bandwidth = bw4, gweight = gwr.Gauss)$SDF
weight.gwr <- res4[,var.select]
df2 <- cbind(df[,!is.element(colnames(df), names(weight.gwr))], weight.gwr)
df2.names <- colnames(data.frame(weight.gwr))
##################################################################################################
pic.can <- list()
count <- 0
for(rn in 1: length(df1.names)){
count <- count + 1
g11 <- ggplot(data = df1, aes_string(fill = df1.names[rn]))  + ggtitle(colnames(weight.r)[rn])
g11 <- g11 + geom_sf(color = "transparent",  size = 0.1)
g11 <- g11 + scale_fill_viridis_c("Contribuion to the Risk \n of covid-19 infection", option = "turbo")
g11 <- g11 + theme_bw() + theme(legend.position = "bottom", plot.title = element_text(size=22), text = element_text(size = 15))
pic.can[[count]] <- g11
count <- count + 1
g22 <- ggplot(data = df2, aes_string(fill = df2.names[rn]))  + ggtitle(df2.names[rn])
g22 <- g22 + geom_sf(color = "transparent",  size = 0.1)
g22 <- g22 + scale_fill_viridis_c("Contribuion to the Risk \n of covid-19 infection", option = "turbo")
g22 <- g22 + theme_bw() + theme(legend.position = "bottom", plot.title = element_text(size=22), text = element_text(size = 15))
pic.can[[count]] <- g22
}
library(ggpubr)
gg1 <-  ggarrange(pic.can[[1]] + labs(title =  rules.select[1])+ guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[3]] + labs(title =  rules.select[2]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[5]]  + labs(title =  rules.select[3]) +  guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[7]] + labs(title =  rules.select[4]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[9]]  + labs(title =  rules.select[5]) +  guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[11]]  + labs(title =  rules.select[6]) +  guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
ncol = 3, nrow = 2, common.legend = TRUE, legend="bottom")
ggsave(paste0(dir,"real_gwim.png"), gg1, width = 18, height = 16)
gg2 <-  ggarrange(pic.can[[2]] + labs(title =  var.select[1]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[4]] + labs(title =  var.select[2]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[6]] + labs(title =  var.select[3]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[8]] + labs(title =  var.select[4]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[10]] + labs(title =  var.select[5]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[12]] + labs(title =  var.select[5]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
ncol = 3, nrow = 2, common.legend = TRUE, legend="bottom")
ggsave(paste0(dir,"real_gwr.png"), gg2, width = 18, height = 16)
gg2 <-  ggarrange(pic.can[[2]] + labs(title =  var.select[1]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[4]] + labs(title =  var.select[2]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[6]] + labs(title =  var.select[3]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[8]] + labs(title =  var.select[4]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[10]] + labs(title =  var.select[5]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
pic.can[[12]] + labs(title =  var.select[6]) + guides(color = guide_legend(nrow = 1))
+ theme(legend.text = element_text(size=10), legend.title = element_text(size=15), axis.text.x=element_blank(), text = element_text(size = 15)),
ncol = 3, nrow = 2, common.legend = TRUE, legend="bottom")
ggsave(paste0(dir,"real_gwr.png"), gg2, width = 18, height = 16)
library(doParallel)
#########################
#dir <- "L:/m-CRE/"
#dir.save <- "D:/MCRE/"
dir <- getwd()
##########################
source(paste0(dir, "/data_gen.R"))
source(paste0(dir, "/mcre_agenet.R"))
### DGP parameters ###
n <- 2000
p <- 10
model.can <- expand.grid(1:3, 2:4)
model.can <- cbind(sim = 1:9, model.can)
Beta.can <- 2*rbind(c(1, 1, 1), c(-0.5, 1.0, 2.0), c(1.5, 1.5, -0.5), c(-1.5, 1.5, 0.5), c(-0.5, 2.0, 0.5))
group.can <- c(3,4,5)
ite.all <- 100
############################################################################################################################
model.all <- NULL
for(g in group.can){
model.set <- cbind(model.can, g)
model.all <- rbind(model.all, model.set)
}
sim.all <- NULL
seed <- 1
m <- 9
### Create the dataset ###
sim.train <- data_gen(n = n, p = p, Beta = Beta.can[1:mod$g,], model = mod[2:3], seed = seed)
mod <- model.all[,m]
mod <- model.all[m,]
mod
### Create the dataset ###
sim.train <- data_gen(n = n, p = p, Beta = Beta.can[1:mod$g,], model = mod[2:3], seed = seed)
sim.test <- data_gen(n = n, p = p, Beta = Beta.can[1:mod$g,], model = mod[2:3], seed = seed + 100)
tau.test <- sim.test$tau
PS.RF <- nnet::multinom(W~., data = data.frame(W = as.factor(sim.train$W), sim.train$X))
W.hat <- predict(PS.RF, newdata = data.frame(sim.train$X), type = "prob")
#####################
### Causal Forest ###
#####################
mcf <- grf::multi_arm_causal_forest(X = sim.train$X, W = as.factor(sim.train$W), Y = sim.train$Y, W.hat = W.hat)
c.pred <- predict(mcf, sim.test$X, estimate.variance = TRUE)
cate <- data.frame(c.pred$predictions)
se   <- sqrt(data.frame(c.pred$variance.estimates))
bound.cf <- list()
cf.cover <- c()
cf.width <- c()
for(c in 1:(mod$g-1)){
ci_lower <- cate[,c] - 1.96 * se[,c]
ci_upper <- cate[,c] + 1.96 * se[,c]
bound.cf[[c]] <- cbind(ci_lower, ci_upper)
cf.cover[c] <- mean(tau.test[,c] >= ci_lower & tau.test[,c] <= ci_upper, na.rm = TRUE)
cf.width[c] <- mean(ci_upper - ci_lower)
}
cf.cover.res <- mean(cf.cover)
cf.width.res <- mean(cf.width)
####################################################
### Proposed Method (GBM based Rule generation ) ###
####################################################
trainprop <- 0.75
alpha <- 0.05
Y <- sim.train$Y
W <- sim.train$W
X <- sim.train$X
### Step 1 : Divide the data into train set and valid set (Balanced split)###
trainid <- c()
inds.train <- list()
for(g in 0:(mod$g-1)){
inds <- which(W == g); n <- length(inds)
trainid_inds <- sample(n, floor(n * trainprop))
trainid <- c(trainid, inds[trainid_inds])
inds.train[[g+1]] <- inds
}
Xtrain <- X[trainid, ,drop=FALSE]; Wtrain <- W[trainid]; Ytrain <- Y[trainid]
Xval <- X[-trainid, ,drop=FALSE]; Wval <- W[-trainid]; Yval <- Y[-trainid]
### Step 2 : Build model using train set ###
### Estimate the propensity score ###
PS.RF <- nnet::multinom(W~., data = data.frame(W = as.factor(Wtrain), Xtrain))
W.hat <- predict(PS.RF, newdata = data.frame(Xtrain), type = "prob")
### Fit the model ###
fit <- mcre_agenet(X = Xtrain, Y = Y[trainid], W = Wtrain, W.hat = W.hat, gen.tree = "gbm", tune.init = "CV", tune.fin = "CV", learnrate = 0.01, seed = seed)
### Step 3 : Compute the nonconformity measures ###
pred <- predict.mcre(fit, newdata = data.frame(Y = Yval, W = as.factor(Wval), Xval))
Wval_dum <- fastDummies::dummy_cols(Wval)[,-1]
E.first <- abs(Yval - pred$y.first*Wval_dum); E <- abs(Yval - pred$y*Wval_dum)
### Step 4 : Compute the conformal interval for treatment estimate
confint.first <- list()
confint <- list()
pred.all <- predict.mcre(fit, newdata = data.frame(sim.test$X))
for(g in 1:length(unique(Wval))){
confint.first[[g]] <- cbind(pred.all$y.first[,g] - quantile(E.first[Wval == (g-1),g], alpha/2), pred.all$y.first[,g] + quantile(E.first[Wval == (g-1),g], (1-alpha/2)))
confint[[g]] <- cbind(pred.all$y[,g] - quantile(E[Wval == (g-1),g], alpha/2), pred.all$y[,g] + quantile(E[Wval == (g-1),g], (1-alpha/2)))
}
### Step 5: Compute the conformal interval for estimated HTE
confint_hte.first <-list()
confint_hte <- list()
pred.all <- predict.mcre(fit, newdata = data.frame(sim.test$X))
for(g in 2:length(unique(Wval))){
confint_hte.first[[g-1]] <- cbind(confint.first[[g]][,1] - confint.first[[1]][,2], confint.first[[g]][,2] - confint.first[[1]][,1])
confint_hte[[g-1]] <- cbind(confint[[g]][,1] - confint[[1]][,2], confint[[g]][,2] - confint[[1]][,1])
}
prop.cover <- c(); prop.cover.first <- c()
prop.width <- c(); prop.width.first <- c()
for(g in 1:(mod$g-1)){
ci_lower.first <- confint_hte.first[[g]][,1];  ci_lower <- confint_hte[[g]][,1]
ci_upper.first <- confint_hte.first[[g]][,2];  ci_upper <- confint_hte[[g]][,2]
prop.cover.first[g] <- mean(tau.test[,g] >= ci_lower.first & tau.test[,g] <= ci_upper.first, na.rm = TRUE)
prop.cover[g] <- mean(tau.test[,g] >= ci_lower & tau.test[,g] <= ci_upper, na.rm = TRUE)
prop.width.first[g] <- mean(ci_upper.first - ci_lower.first)
prop.width[g] <- mean(ci_upper - ci_lower)
}
prop.gbm.cover.res <- c(mean(prop.cover.first), mean(prop.cover))
prop.gbm.width.res <- c(mean(prop.width.first), mean(prop.width))
######################################################
### Proposed Method (ctree based Rule generation ) ###
######################################################
trainprop <- 0.75
alpha <- 0.05
Y <- sim.train$Y
W <- sim.train$W
X <- sim.train$X
### Step 1 : Divide the data into train set and valid set (Balanced split)###
trainid <- c()
inds.train <- list()
for(g in 0:(mod$g-1)){
inds <- which(W == g); n <- length(inds)
trainid_inds <- sample(n, floor(n * trainprop))
trainid <- c(trainid, inds[trainid_inds])
inds.train[[g+1]] <- inds
}
Xtrain <- X[trainid, ,drop=FALSE]; Wtrain <- W[trainid]; Ytrain <- Y[trainid]
Xval <- X[-trainid, ,drop=FALSE]; Wval <- W[-trainid]; Yval <- Y[-trainid]
### Step 2 : Build model using train set ###
### Estimate the propensity score ###
PS.RF <- nnet::multinom(W~., data = data.frame(W = as.factor(Wtrain), Xtrain))
W.hat <- predict(PS.RF, newdata = data.frame(Xtrain), type = "prob")
### Fit the model ###
fit <- mcre_agenet(X = Xtrain, Y = Y[trainid], W = Wtrain, W.hat = W.hat, gen.tree = "ctree", tune.init = "CV", tune.fin = "CV", learnrate = 0.01, seed = seed)
### Step 3 : Compute the nonconformity measures ###
pred <- predict.mcre(fit, newdata = data.frame(Y = Yval, W = as.factor(Wval), Xval))
Wval_dum <- fastDummies::dummy_cols(Wval)[,-1]
E.first <- abs(Yval - pred$y.first*Wval_dum); E <- abs(Yval - pred$y*Wval_dum)
### Step 4 : Compute the conformal interval for treatment estimate
confint.first <- list()
confint <- list()
pred.all <- predict.mcre(fit, newdata = data.frame(sim.test$X))
for(g in 1:length(unique(Wval))){
confint.first[[g]] <- cbind(pred.all$y.first[,g] - quantile(E.first[Wval == (g-1),g], alpha/2), pred.all$y.first[,g] + quantile(E.first[Wval == (g-1),g], (1-alpha/2)))
confint[[g]] <- cbind(pred.all$y[,g] - quantile(E[Wval == (g-1),g], alpha/2), pred.all$y[,g] + quantile(E[Wval == (g-1),g], (1-alpha/2)))
}
### Step 5: Compute the conformal interval for estimated HTE
confint_hte.first <-list()
confint_hte <- list()
pred.all <- predict.mcre(fit, newdata = data.frame(sim.test$X))
for(g in 2:length(unique(Wval))){
confint_hte.first[[g-1]] <- cbind(confint.first[[g]][,1] - confint.first[[1]][,2], confint.first[[g]][,2] - confint.first[[1]][,1])
confint_hte[[g-1]] <- cbind(confint[[g]][,1] - confint[[1]][,2], confint[[g]][,2] - confint[[1]][,1])
}
prop.cover <- c(); prop.cover.first <- c()
prop.width <- c(); prop.width.first <- c()
for(g in 1:(mod$g-1)){
ci_lower.first <- confint_hte.first[[g]][,1];  ci_lower <- confint_hte[[g]][,1]
ci_upper.first <- confint_hte.first[[g]][,2];  ci_upper <- confint_hte[[g]][,2]
prop.cover.first[g] <- mean(tau.test[,g] >= ci_lower.first & tau.test[,g] <= ci_upper.first, na.rm = TRUE)
prop.cover[g] <- mean(tau.test[,g] >= ci_lower & tau.test[,g] <= ci_upper, na.rm = TRUE)
prop.width.first[g] <- mean(ci_upper.first - ci_lower.first)
prop.width[g] <- mean(ci_upper - ci_lower)
}
prop.ctree.cover.res <- c(mean(prop.cover.first), mean(prop.cover))
prop.ctree.width.res <- c(mean(prop.width.first), mean(prop.width))
cover.res <- data.frame(mcf = cf.cover.res, gbm.gl = prop.gbm.cover.res[1], gbm.agl = prop.gbm.cover.res[2],
ctree.gl = prop.ctree.cover.res[1], ctree.agl = prop.ctree.cover.res[2], evl = "cover_r")
width.res <- data.frame(mcf = cf.width.res, gbm.gl = prop.gbm.width.res[1], gbm.agl = prop.gbm.width.res[2],
ctree.gl = prop.ctree.width.res[1], ctree.agl = prop.ctree.width.res[2], evl = "width")
sim.evl <- rbind(cover.res, width.res)
sim.evl$ite <- seed
sim.eve
sim.evl
